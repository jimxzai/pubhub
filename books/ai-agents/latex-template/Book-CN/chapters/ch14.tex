\chapter{监控、调试和改进}

\section{无声的故障}

邮件来自我最好的客户：\textit{``过去一周我们每个支持请求都收到同样的回复。你们的系统坏了吗？''}

我查看了仪表板。所有系统显示绿色。没有记录错误。代理状态：运行中。

但当我查看实际输出时，我看到了问题：

\begin{itemize}
\item Casey连续七天对每张工单发送相同的固定回复
\item 底层的Claude API开始返回缓存错误
\item 我的系统将其解释为有效回复
\item 没有崩溃。没有警报。只是无声地错误输出，乍一看还像是对的
\end{itemize}

客户已经收到了十七个完全相同的回复。他们的耐心已经耗尽。

这就是我学到的关于AI代理最重要的教训：\textbf{它们会无声地失败}。与传统软件会大声崩溃不同，代理可以产生看起来正确但实际错误的输出。如果没有适当的监控，你不会知道，直到客户抱怨——或者离开。

\section{可观测性层级}

在那次事件之后，我从头重建了我的监控系统。我现在从四个层次来思考可观测性，每一层回答不同的问题：

\begin{codebox}
\begin{lstlisting}[style=python]
可观测性层级

健康：代理在运行吗？
- 正常运行时间、错误率、API连接性
- "代理能正常工作吗？"
    |
    v
活动：它在做什么？
- 处理的任务、数量、模式
- "代理在处理正确的事情吗？"
    |
    v
质量：它做得好吗？
- 准确性、覆盖率、上报情况
- "输出正确吗？"
    |
    v
影响：它在实现目标吗？
- 业务指标、节省时间、收入
- "这让我们的业务变好了吗？"

大多数创始人止步于健康。
价值在于质量和影响。
\end{lstlisting}
\end{codebox}

\section{要监控什么}

让我向你展示我具体跟踪什么，以及为什么。

\subsection{健康指标}

这些是你的基准线。如果健康指标失败，其他什么都不重要。

\begin{codebox}
\begin{lstlisting}[style=python]
健康仪表板

系统状态：
|-- 代理状态：运行中 / 已停止 / 错误
|-- 上次成功运行：2分钟前
|-- 错误率（24小时）：2.1%
|-- API可用性：99.8%
`-- 队列深度：3个待处理项目

资源使用：
|-- 今日API调用：847 / 2,000限制
|-- Token使用：1.2M / 5M每日预算
|-- 今日成本：$4.23
|-- 本月至今成本：$89.50
`-- 预计月度：$142

警报阈值：
|-- 错误率 > 5% -> 警告
|-- 错误率 > 10% -> 严重
|-- API调用 > 80%限制 -> 警告
|-- 成本 > 150%预算 -> 警报
\end{lstlisting}
\end{codebox}

\subsection{活动指标}

活动告诉你代理是否在做它们应该做的事——以及预期的数量。

\begin{codebox}
\begin{lstlisting}[style=python]
活动跟踪

数量：
|-- 今日处理任务：127
|-- 每小时平均：12.7
|-- 高峰时段：上午10点（23个任务）
|-- 趋势：比上周+8%

按代理：
|-- Emma（邮件）：处理89个
|-- Sam（潜在客户）：筛选12个
|-- Casey（支持）：解决18个
|-- Maya（内容）：创建3个
|-- Finn（发票）：发送4个
`-- Oscar（订单）：处理1个

时间：
|-- 平均处理时间：3.2秒
|-- 95分位：8.4秒
|-- 最慢任务：24秒（内容）
|-- 队列等待时间：0.5秒

危险信号：
|-- 数量比正常下降 > 30% -> 警报
|-- 处理时间 > 正常2倍 -> 调查
|-- 任何代理数量为0 -> 立即检查
\end{lstlisting}
\end{codebox}

\subsection{质量指标}

这是大多数问题隐藏的地方。你的代理可能运行得很好但产出的是垃圾。

\begin{codebox}
\begin{lstlisting}[style=python]
质量评分卡

整体质量：
|-- 人工覆盖率：8%
|   （目标：<15%）
|-- 上报率：6%
|   （目标：<10%）
|-- 错误率：2%
|   （目标：<5%）
|-- 客户满意度：4.6/5
|   （目标：>4.5）

按代理：
|-- Emma：94%准确率（邮件原样发送）
|-- Sam：88%筛选准确率
|-- Maya：92%内容批准率
|-- Casey：78%首次联系解决率
|-- Finn：99%发票准确率
`-- Oscar：97%订单准确率

质量趋势：
|-- 本周与上周对比
|-- 任何下降 > 5% -> 调查
|-- 连续三次下降 -> 需要行动
\end{lstlisting}
\end{codebox}

\subsection{影响指标}

这是底线：投资是否有回报？

\begin{codebox}
\begin{lstlisting}[style=python]
业务影响

时间节省：
|-- 本周节省小时：28
|-- 等值工资价值：$1,400
|-- 本会错过的任务：7

收入影响：
|-- 非工作时间捕获的潜在客户：8
|-- 更快响应 -> 更高转化：+12%
|-- 支持解决 -> 更低流失：-2%
`-- 归因于代理的收入：~$4,500/月

成本指标：
|-- 代理总成本：$187/月
|-- 每任务成本：$0.15
|-- 投资回报率：24:1
`-- 盈亏平衡：每月第2天

故事：
"花$187/月，我的代理节省了120+小时
并贡献了~$4,500的收入。这是
大约24倍的投资回报率。"
\end{lstlisting}
\end{codebox}

\section{构建你的仪表板}

你不需要复杂的工具。这是有效的方法：

\subsection{单一视图}

每天早上，我看一个屏幕：

\begin{codebox}
\begin{lstlisting}[style=python]
+------------------------------------------------------------+
| AI代理指挥中心                        上次更新：2分钟前     |
|------------------------------------------------------------|
|                                                            |
| 系统状态                                                   |
| +----------+----------+----------+----------+----------+   |
| |  EMMA    |   SAM    |   MAYA   |  CASEY   |   FINN   |   |
| |   [OK]   |   [OK]   |   [OK]   |  [警告]  |   [OK]   |   |
| | 运行中   | 运行中   | 运行中   | 延迟     | 运行中   |   |
| +----------+----------+----------+----------+----------+   |
|                                                            |
| 今日活动                                                   |
| 处理邮件：       127 ####################                  |
| 筛选潜在客户：    12 ####                                  |
| 创建内容：         3 #                                     |
| 解决支持：        23 #######                               |
| 发送发票：         4 #                                     |
|                                                            |
| 质量分数                                                   |
| 覆盖率：         8% [OK]（目标 <15%）                       |
| 上报率：         6% [OK]（目标 <10%）                       |
| 错误率：         2% [OK]（目标 <5%）                        |
|                                                            |
| 今日成本：$4.23 / $10预算                                  |
|                                                            |
| !! 需要注意                                                |
| -> Casey队列积压（3张工单 >2小时）                          |
|                                                            |
+------------------------------------------------------------+
\end{lstlisting}
\end{codebox}

一眼就能看到：系统健康、活动水平、质量指标，以及任何需要注意的事项。五秒钟就能了解我的AI团队的状态。

\subsection{简单实现}

你不需要昂贵的可观测性工具。n8n + Notion完美配合：

\begin{codebox}
\begin{lstlisting}[style=python]
仪表板工作流（n8n）

每小时：
1. 查询每个代理的近期活动
2. 计算指标（聚合、平均）
3. 更新Notion仪表板页面
4. 检查警报条件
5. 如发现问题发送Slack通知

每天早上7点：
1. 生成完整日报
2. 与前一天比较
3. 识别趋势和异常
4. 邮件摘要到收件箱
\end{lstlisting}
\end{codebox}

我的Notion仪表板页面：

\begin{codebox}
\begin{lstlisting}[style=bash]
# 代理仪表板

## 系统状态（每小时自动更新）
| 代理  | 状态   | 上次运行   | 错误率  |
|-------|--------|------------|---------|
| Emma  | [OK]   | 2分钟前    | 1.2%    |
| Sam   | [OK]   | 5分钟前    | 0.8%    |
| Maya  | [OK]   | 1小时前    | 0.0%    |
| Casey | [警告] | 15分钟前   | 3.1%    |
| Finn  | [OK]   | 3小时前    | 0.0%    |

## 今日活动
- 邮件：127（比昨天+12%）
- 潜在客户：12（3热门，5温和，4冷淡）
- 内容：3篇（1博客，2社交）
- 支持：23张工单（21已解决）
- 发票：4张已发送（共$12,500）

## 质量指标
- 覆盖率：8%
- 上报率：6%
- 错误率：2%

## 成本
- 今日：$4.23
- 本月至今：$89.50
- 预计：$142

## 警报
- [ ] Casey：3张工单等待 >2小时

## 近期错误（过去24小时）
| 时间  | 代理  | 错误       | 状态       |
|-------|-------|------------|------------|
| 9:23  | Sam   | API超时    | 已解决     |
| 14:15 | Emma  | 解析错误   | 调查中     |
\end{lstlisting}
\end{codebox}

\section{错误处理模式}

当事情出错时——而且一定会出错——你需要优雅降级，而不是灾难性失败。

\subsection{错误层级}

\begin{codebox}
\begin{lstlisting}[style=python]
错误处理级别

级别1：重试
瞬时错误（API超时、速率限制）
-> 等待，最多重试3次
-> 示例：Claude返回503 -> 等待30秒 -> 重试

级别2：回退
主要方法持续失败
-> 使用备用方法
-> 示例：Claude宕机 -> 使用缓存响应

级别3：排队
现在无法处理
-> 添加到稍后重试队列
-> 示例：速率限制 -> 排队5分钟后处理

级别4：上报
代理无法处理情况
-> 警报人工，暂停处理
-> 示例：未知错误类型 -> Slack警报

级别5：安全失败
严重故障，潜在危害
-> 停止代理，立即通知
-> 示例：发送给错误收件人 -> 停止
\end{lstlisting}
\end{codebox}

\subsection{错误响应手册}

\begin{codebox}
\begin{lstlisting}[style=bash]
# 错误处理手册

## API错误

### 429 速率限制
1. 记录错误和时间戳
2. 检查retry-after头（或等待60秒）
3. 重试请求
4. 如果重试3次后仍失败，排队稍后处理
5. 如果队列超过50个项目则警报

### 503 服务不可用
1. 记录错误
2. 等待30秒
3. 使用指数退避最多重试3次
4. 如果仍然失败，切换到回退或排队
5. 如果停机超过15分钟则警报

### 401 未授权
1. 记录为严重
2. 立即警报（API密钥问题）
3. 暂停代理直到解决
4. 检查：密钥过期？密钥错误？已撤销？

## 内容错误

### 检测到幻觉
迹象：编造的统计数据、虚构的功能、错误的事实
1. 不要发送响应
2. 标记人工审查
3. 记录提示/响应以供分析
4. 如果模式持续，调整提示

### 不符合品牌的响应
迹象：语气错误、内容不当、过于随意/正式
1. 不发送
2. 用更强的品牌指南重新生成
3. 如果仍然不对，上报给人工
4. 记录以改进提示

### 不完整的响应
迹象：截断、缺少部分、句子中间断开
1. 检查是否达到token限制
2. 用更短的上下文重试
3. 如需要分成多个请求
4. 调整上下文管理
\end{lstlisting}
\end{codebox}

\section{调试AI代理}

当出问题时，这是如何找到并修复它的方法。

\subsection{调试工作流}

\begin{codebox}
\begin{lstlisting}[style=python]
当出问题时

1. 复现
   你能让它再次发生吗？
   相同输入 -> 相同错误输出？
   如果不能复现，检查竞态条件
   或外部依赖。

2. 隔离
   哪个组件失败了？
   - 输入解析？（检查原始输入）
   - 上下文检索？（检查发送了什么上下文）
   - AI生成？（检查提示和响应）
   - 输出处理？（检查后处理）

3. 检查
   查看实际数据：
   - 发送的确切提示是什么？
   - 包含了什么上下文？
   - 原始AI响应是什么？
   - 它在哪里偏离了预期？

4. 假设
   为什么会发生这种情况？
   - 提示中的模糊指令？
   - 缺少需要的上下文？
   - 手册中未覆盖的边缘情况？
   - AI的"创造力"覆盖了指令？

5. 修复
   更新相关组件：
   - 更清晰的提示语言？
   - 额外的上下文包含？
   - 对此情况的明确处理？
   - 更强的约束？

6. 验证
   测试修复：
   - 相同输入现在产生正确输出？
   - 其他输入仍然正常工作？
   - 没有引入新问题？
\end{lstlisting}
\end{codebox}

\subsection{常见问题和修复}

这是我最常见到的问题：

\begin{codebox}
\begin{lstlisting}[style=python]
问题：语气或风格错误
症状：响应不匹配品牌声音
原因：风格指南薄弱或缺失
修复：添加好/坏语气的具体示例
     "这样写：'...' 不要这样写：'...'"

问题：幻觉信息
症状：代理编造事实、统计数据、功能
原因：被要求在没有足够知识的情况下回答
修复：添加明确指令：
     "只使用提供的上下文中的信息。
      如果你不知道，说'我会确认后
      再回复你。'"

问题：忽视指令
症状：代理不遵循手册步骤
原因：指令太长或太复杂
修复：简化，使用编号步骤，添加：
     "你必须按顺序遵循这些步骤。
      绝不跳过步骤。"

问题：输出不一致
症状：相同输入产生不同输出
原因：模糊指令允许变化
修复：添加结构化输出格式：
     "只返回这个JSON格式：{...}"
     如果直接使用API，降低temperature。

问题：上下文溢出
症状：代理忽略近期或重要信息
原因：上下文太多，旧信息被优先
修复：总结旧上下文，优先近期，
     明确标记什么最重要。
\end{lstlisting}
\end{codebox}

\subsection{要记录什么}

好的日志使调试成为可能。糟糕的日志使它不可能。

\begin{codebox}
\begin{lstlisting}[style=python]
# 每个代理操作要记录什么

log_entry = {
    "timestamp": "2026-01-28T14:30:00Z",
    "agent": "Sam",
    "action": "lead_qualification",
    "task_id": "task_abc123",

    "input": {
        "lead_id": "lead_123",
        "source": "typeform",
        "message_preview": "前100个字符..."
    },

    "context_used": {
        "customer_file": "included",
        "playbook": "lead-qualification-v2",
        "tokens_in": 1250
    },

    "output": {
        "score": 85,
        "tier": "hot",
        "action_taken": "sent_response",
        "tokens_out": 150
    },

    "performance": {
        "duration_ms": 2340,
        "api_calls": 1,
        "cost_usd": 0.003
    },

    "quality": {
        "human_override": false,
        "escalated": false,
        "error": null
    }
}

# 有了这个，你可以回答：
# - 发生了什么？（输入、输出）
# - 为什么？（上下文、手册）
# - 表现如何？（质量、性能）
# - 要修复什么？（比较好的和坏的输出）
\end{lstlisting}
\end{codebox}

\section{持续改进}

你的代理应该每周都变得更好。这是日常工作。

\subsection{每周回顾}

每周一早上，三十分钟：

\begin{codebox}
\begin{lstlisting}[style=python]
每周代理回顾（30分钟）

1. 检查仪表板（5分钟）
   - 有代理宕机或出错吗？
   - 异常的数量模式？
   - 成本在轨道上吗？
   - 有未处理的警报吗？

2. 审查覆盖（10分钟）
   - 拉取过去一周所有人工覆盖
   - 按原因分类：
     - 语气错误：X次
     - 信息错误：X次
     - 缺少上下文：X次
     - 其他：X次
   - 识别前3个可修复的模式

3. 检查上报（5分钟）
   - 上报是否适当？
   - 有应该由代理处理的吗？
   - 有遗漏应该上报的吗？

4. 抽样输出（5分钟）
   - 随机抽样10个输出
   - 对每个评分：A / B / C / F
   - 记录任何问题或改进

5. 计划改进（5分钟）
   - 选择1-2个本周要修复的事项
   - 创建具体任务
   - 安排时间实施
\end{lstlisting}
\end{codebox}

\subsection{每月深度审查}

每月一次，两小时的集中改进：

\begin{codebox}
\begin{lstlisting}[style=python]
每月代理审计（2小时）

指标审查（30分钟）
|-- 月度环比趋势
|-- 成本分析和优化机会
|-- 质量分数变化
|-- 业务影响评估
`-- 我们随着时间获得更多价值了吗？

手册审查（30分钟）
|-- 手册还准确吗？
|-- 有新的边缘情况要添加吗？
|-- 有过时信息要删除吗？
|-- 有更好的示例可用吗？
`-- 有流程变化需要更新吗？

提示优化（30分钟）
|-- 审查系统提示
|-- 测试任何改进假设
|-- 对样本数据进行A/B测试
|-- 根据学习更新
`-- 记录什么有效什么无效

路线图（30分钟）
|-- 什么工作得特别好？
|-- 什么最需要改进？
|-- 有新能力要添加吗？
|-- 依赖或阻碍因素？
`-- 下个月计划
\end{lstlisting}
\end{codebox}

\subsection{A/B测试提示}

当你想改进某些东西时，正确测试它：

\begin{codebox}
\begin{lstlisting}[style=python]
A/B测试框架

设置：
1. 创建变体提示（只改变一处）
2. 将20%流量路由到变体
3. 运行至少1周（统计显著性）
4. 对两者测量相同指标

要比较的指标：
|-- 任务完成率
|-- 人工覆盖率
|-- 客户满意度（如可测量）
|-- 处理时间
|-- 每任务成本

决策标准：
|-- 变体明显更好？-> 100%推出
|-- 变体明显更差？-> 立即回滚
|-- 无显著差异？-> 保留更简单的

示例：

当前提示：
"专业地回复客户邮件。"

变体提示：
"用亲切、乐于助人的语气回复客户邮件。
先用名字称呼他们。以
明确的下一步或问题结束。"

1周后结果：
|-- 覆盖率：12% -> 6%（变体胜）
|-- 客户回复率：40% -> 52%（变体胜）
|-- 处理时间：相同
|-- 成本：相同

决定：100%推出变体
\end{lstlisting}
\end{codebox}

\section{警报配置}

警报应该为正确的事情唤醒你，而不是狼来了。

\subsection{警报级别}

\begin{codebox}
\begin{lstlisting}[style=python]
警报配置

严重（立即 - 短信 + 如需要电话）：
|-- 任何代理完全宕机
|-- 错误率 >20%
|-- 发送给错误收件人
|-- 检测到安全事件
|-- 成本 >每日预算的300%
行动：醒来，立即修复

高（1小时内 - Slack + 邮件）：
|-- 错误率 >10%
|-- 队列 >50个项目积压
|-- 覆盖率 >25%
|-- API持续失败
|-- 成本 >预算的150%
行动：尽快处理

中（每日摘要）：
|-- 错误率 >5%
|-- 质量分数下降
|-- 出现新错误类型
|-- 异常模式
行动：明天审查，计划修复

低（每周审查）：
|-- 轻微质量波动
|-- 需要记录的边缘情况
|-- 改进机会
|-- 功能请求
行动：批量用于每周审查
\end{lstlisting}
\end{codebox}

\subsection{警报消息格式}

当警报触发时，它们应该告诉你需要知道的一切：

\begin{codebox}
\begin{lstlisting}[style=python]
警报模板

[严重] Sam - 错误率25%

发生了什么：
自下午2:15以来所有新潜在客户的
筛选都失败。Claude API持续返回503错误。

影响：
过去45分钟有15个潜在客户未处理。
潜在的热门潜在客户正在变冷。

当前状态：
持续中。每个请求都有错误。

需要立即行动：
1. 检查Claude状态页面
2. 如果是他们的问题：等待并监控
3. 如果是我们的问题：检查API密钥和配额

详情：
https://dashboard.example.com/agents/sam/errors

---

这告诉我：
- 什么出了问题（Sam，错误率）
- 为什么（API 503错误）
- 影响（15个潜在客户，潜在收入损失）
- 该做什么（检查状态，然后API密钥）
- 在哪里查看（详情链接）

我可以在30秒内行动，而不是30分钟。
\end{lstlisting}
\end{codebox}

\section{恢复程序}

当事情严重损坏时，你需要恢复手册。

\begin{codebox}
\begin{lstlisting}[style=python]
恢复手册

代理宕机：
1. 检查系统状态（API提供商、你的基础设施）
2. 检查日志查找具体错误
3. 如果是API问题：等待并监控，如延长通知客户
4. 如果是配置问题：修复并重启
5. 处理任何排队项目
6. 如果重大进行事后分析

发送了错误输出：
1. 立即停止代理
2. 评估损害（影响了多少人？）
3. 如果<10个收件人：手动更正 + 道歉
4. 如果>10个收件人：批量更正邮件
5. 考虑主动客户沟通
6. 在重启前修复根本原因
7. 记录以防止再次发生

数据损坏：
1. 暂停所有受影响的工作流
2. 识别问题范围
3. 如需要从备份恢复
4. 验证数据完整性
5. 带额外监控恢复
6. 记录原因和预防措施

成本超支：
1. 检查是什么导致高使用量
2. 暂停非关键代理
3. 减少批量大小和频率
4. 调查异常模式
5. 设置更严格的限制
6. 带监控恢复
\end{lstlisting}
\end{codebox}

\section{改进指标}

跟踪你随时间的进步：

\begin{codebox}
\begin{lstlisting}[style=python]
改进跟踪

                    第1周   第4周   第12周  目标
-------------------------------------------------------
覆盖率              25%      15%       8%       <10%
上报率              20%      12%       6%       <10%
错误率               8%       4%       2%        <3%
首次联系解决        60%      75%      85%       >80%
每任务成本        $0.05    $0.03    $0.02     <$0.03
平均处理时间        45秒     30秒     15秒      <20秒

这些数字讲述的故事：
- 第1周：代理勉强能用，需要很多手把手
- 第4周：提示优化，主要问题已修复
- 第12周：代理可靠，持续小改进

这是正常的。预计80%的改进在第一个月。
\end{lstlisting}
\end{codebox}

\begin{keyinsight}[可观测性公式]
AI代理会无声地失败。捕捉问题的唯一方法是持续监控。

\textbf{健康}回答：它在运行吗？

\textbf{活动}回答：它在工作吗？

\textbf{质量}回答：它正确吗？

\textbf{影响}回答：它有价值吗？

监控所有四个。适当警报。每周审查。持续改进。

还记得我十七个相同的回复吗？它们发生是因为我只监控健康。代理``完美运行''——一遍又一遍运行同样的错误回复。质量监控本可以在几小时内而不是几天内发现它。

\textbf{观察 $\rightarrow$ 测量 $\rightarrow$ 改进 $\rightarrow$ 重复}

这是将不可靠的代理转变为可信赖的团队成员的循环。它永远不会结束。代理变得更好。你的业务变得更好。你的睡眠变得更好。

从第一天就建立监控。你以后会感谢自己。
\end{keyinsight}

\textbf{下一章：}高级销售自动化——用复杂的手册将Sam从好变成卓越。
